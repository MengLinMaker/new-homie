name: ci-clean

on:
  delete

jobs:
  remove-test-infra:
      name: Remove SST - removes test infrastructure
      if: github.event.ref_type == 'branch'
      runs-on: ubuntu-24.04-arm
      steps:
        - name: Deep checkout branch
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Setup dependencies Nx
          uses: ./.github/actions/setup-cd

        - name: Remove SST infrastructure
          run: pnpm sst remove --stage ${{ github.event.ref }}
          env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            DB_SERVICE_SCRAPE: ${{ secrets.DB_SERVICE_SCRAPE }}
            OTEL_EXPORTER_OTLP_ENDPOINT: ${{ secrets.OTEL_EXPORTER_OTLP_ENDPOINT }}
            OTEL_EXPORTER_OTLP_HEADERS: ${{ secrets.OTEL_EXPORTER_OTLP_HEADERS }}
